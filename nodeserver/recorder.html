
<!DOCTYPE html>
<html>
    <head>
        <title>Stream</title>
    </head>
    <body>
    <h1>RECORDER</h1>
        <button id="record">Start Recording</button><button id="stop">Stop Recording</button>

<canvas id="sender"></canvas>
<video id="video" style="display:none;"></video>  
<div id="message"></div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/binaryjs/0.2.1/binary.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.7.1/modernizr.min.js"></script>
        <script type="text/javascript">
            function getParameterByName(name, url) {
                if (!url) url = window.location.href;
                name = name.replace(/[\[\]]/g, "\\$&");
                var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                    results = regex.exec(url);
                if (!results) return null;
                if (!results[2]) return '';
                return decodeURIComponent(results[2].replace(/\+/g, " "));
            }
        </script>
        <script type="text/javascript">
            var streamOn = false;
/////////
function Audio (window) {
  var audioClient = new BinaryClient('ws://localhost:4702/audio-server');
  var channel = getParameterByName('channel');
  var thatWindow = window;
  audioClient.on('open',function (){
    thatWindow.Stream = audioClient.createStream(channel);
     if (!navigator.getUserMedia)
      navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia ||
    navigator.mozGetUserMedia || navigator.msGetUserMedia;

  });

  function success(e) {
      audioContext = thatWindow.AudioContext || thatWindow.webkitAudioContext;
      context = new audioContext();

      // the sample rate is in context.sampleRate
      audioInput = context.createMediaStreamSource(e);

      var bufferSize = 16384;
      recorder = context.createScriptProcessor(bufferSize, 4, 4);

      recorder.onaudioprocess = function(e){
        if (!streamOn) return;
        var left = e.inputBuffer.getChannelData(0);
        thatWindow.Stream.write(left);
      }

      audioInput.connect(recorder)
      recorder.connect(context.destination); 
  };

  this.init = function() {
   
    if (navigator.getUserMedia) {
      navigator.getUserMedia({audio:true}, success, function(e) {
        alert('Error capturing audio.');
      });
    } else alert('getUserMedia not supported in this browser.');

  };

  this.stop = function() {
    thatWindow.Stream.end();
  };
};


/////////

            function Video () {
                var settings = {
                    grabRate: 66.7,
                    canvasWidth: 200,
                    canvasHeight: 160,
                    videoSocketSrv: 'ws://localhost:4705/video-server'
                };

                var channel = getParameterByName('channel');
                var stream;
                var senderEl = document.getElementById('sender');
                var videoEl = document.getElementById('video');

                var senderContext = senderEl.getContext('2d');
                var videoClient = new BinaryClient(settings.videoSocketSrv);
                var userMedia = Modernizr.prefixed('getUserMedia', navigator);

                senderEl.width = settings.canvasWidth;
                senderEl.height = settings.canvasHeight;

                videoEl.width = settings.canvasWidth;
                videoEl.height = settings.canvasHeight;

                if (!userMedia) {
                    // damn, old browser :-(
                    return alert('your browser is not supported');
                }

                videoClient.on('open', function (s) {
                    stream = videoClient.createStream(channel);

                });

                // gets called in an certain interval and grabs the current video frame
                // and draws it into a canvas
                var grabLoop = function () {
                    try {
                        senderContext.drawImage(videoEl, 0, 0, settings.canvasWidth, settings.canvasHeight);
                    } catch (e) {
                        console.error(e);
                    };
                    var imageData = senderContext.getImageData(0, 0, settings.canvasWidth, settings.canvasHeight);
                    if (typeof stream !== 'undefined') {
                        stream.write(imageData.data);
                    }else{
                        console.error("algo paso");
                    }
                    if (!streamOn) return;
                    setTimeout(grabLoop, settings.grabRate);
                };

                // gets called as soon we have access to the camera..

                var gUsuccess = function (stream) {
                    videoEl.src = window.URL.createObjectURL(stream);
                    videoEl.play();
                    setTimeout(grabLoop, settings.grabRate);
                };

                // no camera access...
                var gUfail = function () {
                    console.log('no webcam access :-( guachin');
                };

                this.init  = function () {
                    streamOn = true;
                    userMedia({video: true}, gUsuccess, gUfail);
                },
                this.stop = function () {
                    streamOn = false;
                }

            }
            
        var that = this;
        var videoObj = new Video();
        var audioObj = new Audio(window);
        function startRecording(videoObj, audioObj) {
           videoObj.init();
           audioObj.init();
        };
        function stopRecording(videoObj, audioObj) {
            videoObj.stop();
            audioObj.stop();
        };
        
        $('#record').on('click',function (){startRecording(videoObj, audioObj)});
        $('#stop').on('click',function (){stopRecording(videoObj, audioObj)});
        </script>

        </body></html>



